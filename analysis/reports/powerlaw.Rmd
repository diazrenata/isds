---
title: "Power law - truncated Pareto"
output: html_notebook
---
From Thibault et al 2011:

"Using individual-level masses, we fitted the three major classes of frequency distributions to the data. We used the power law to characterize the monotonic decrease. Specifically, we fitted the truncated Pareto distribution to log10-transformed data using mle.truncpareto.m from White et al 2008, estimating the true minimum and maximum sizes using observed values (which overestimates the quality of the fit and is therefore conservative in this context). This produces an estimate of the frequency distribution of sizes comparable to traditional analyses of ISDs in trees (refs...) and the number density spectrum used in aquatic systems (sensu Andersen & Beyer 2006), with the data transformation affecting the exponent (but not the form) of the power function."

```{r load empirical ISD}

library(isds)
library(drake)

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("drake", "drake-cache.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

isd_dat1 <- readd(isd_dat1, cache = cache)

head(isd_dat1)

isd_dat1 <- isd_dat1 %>%
  dplyr::mutate(log10_size = log(wgt, base = 10))



```

Fit raw

```{r fitting raw}
library(VGAM)

isd_dat1 <- isd_dat1 %>%
  dplyr::arrange(wgt)

plot(isd_dat1$wgt)

min_r <- min(isd_dat1$wgt)
max_r <- max(isd_dat1$wgt)

toy_p <- rtruncpareto(n=778, lower = min_r, upper = max_r, shape = 15)

toy_p <- sort(toy_p, decreasing = TRUE)
plot(toy_p)

toy_p <- data.frame(
  y = toy_p
)

fit1 <- vglm(y ~ 1, truncpareto(min_r, max_r), data = toy_p)
fit1@extra

AIC(fit1)

raw_isd <- isd_dat1 %>%
  dplyr::select(wgt) %>%
  dplyr::mutate(y = wgt) %>%
  dplyr::select(y)

fit2 <- vglm(y ~ 1, truncpareto(min_r - 1, max_r + 1), data = raw_isd)

log10_isd <- isd_dat1 %>%
  dplyr::select(log10_size) %>%
  dplyr::mutate(y = log10_size) %>%
  dplyr::select(y)

fit3 <- vglm(y ~ 1, truncpareto(min(log10_isd$y) - .01, max(log10_isd$y) + .01), data = log10_isd)

```
`vglm` cannot fit a truncated Pareto to either the raw or the log10-transformed data. Is it just too far from a powerlaw for the MLE to work?
