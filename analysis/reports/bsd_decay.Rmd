---
title: "BSD decay?"
output: github_document
---

```{r setup}
library(isds)
library(ggplot2)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(echo = TRUE)

toyp <- get_toy_portal_data(years = 1990:2010)

ebsd <- toyp %>%
  group_by(species) %>%
  summarize(meanwgt = mean(wgt)) %>%
  ungroup() %>%
  mutate(logwgt = log(meanwgt))

set.seed(1977)

uniform_log_bsd <- draw_uniform_bsd(s = nrow(ebsd), min =  min(ebsd$logwgt), max =max(ebsd$logwgt))

unimodal_log_bsd <- draw_unimodal_bsd(ebsd$logwgt)

mmodal_log_bsd_full <- draw_multimodal_bsd(emp_vector = ebsd$logwgt, min_mode_gap = .5, min_sd_coeff = .3, max_sd_coeff = .3)

mmodal_log_bsd <- mmodal_log_bsd_full$bsd
```


```{r visualize}

all_log_bsds <- data.frame(
  vals = c(mmodal_log_bsd, uniform_log_bsd, unimodal_log_bsd, ebsd$logwgt),
  source = c(rep("multimodal", nrow(ebsd)),
             rep("uniform", nrow(ebsd)), 
             rep("unimodal", nrow(ebsd)),
             rep("empirical", nrow(ebsd)))
)


all_log_bsd_plot <- ggplot(data = all_log_bsds, aes(x = vals, y = source, color = source)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none")

all_log_bsd_plot

```

```{r best nb clumps}

best_clumps <- all_log_bsds %>%
  group_by(source) %>%
  summarize(nb_clumps = get_n_clumps(vals)) %>%
  ungroup()

best_clumps

even_test <- seq(min(ebsd$logwgt), max(ebsd$logwgt), length.out = length(ebsd$logwgt))

get_n_clumps(even_test)

```

What about the proportion of variation accounted for via clustering (within cluster SSQ / total SSQ) of the focal BSD vs. its completely-even counterpart? 


#### old scraps
```{r versus even, include = F, eval = F}

get_ssq_vs_even <- function(bsd, nbclumps) {
  
  even_counterpart <- seq(min(bsd), max(bsd), length.out = length(bsd))
  
  this_kmeans <- kmeans(bsd, nbclumps)
  this_even <- kmeans(even_counterpart, nbclumps)
  
  this_prop_var <- this_kmeans$betweenss / this_kmeans$totss
  this_even_pv <- this_even$betweenss / this_even$totss
  
  return(this_prop_var - this_even_pv)
  
}



all_log_v_even <- list() 
for(i in 1:6) {
  all_log_v_even[[i]] <-  all_log_bsds %>%
    group_by(source) %>%
    summarize(vs_even = get_ssq_vs_even(vals, nbclumps = i)) %>%
    ungroup() %>%
    mutate(nbclumps = i)
}
all_log_v_even <- bind_rows(all_log_v_even)


log_v_even_plot <-  ggplot(data = all_log_v_even, aes(x = nbclumps, y = vs_even, color = source)) +
  geom_point() +
  theme_bw() 

log_v_even_plot


```


